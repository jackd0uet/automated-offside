{% extends "base_generic.html" %}

{% block content %}
<div class="container mt-4">
    <h1 class="text-center mb-5 display-4 fw-semibold">Upload a Match Image to Visualise Positions</h1>

    <div class="row justify-content-center">
        <div class="col-md-12 col-lg-10 col-xl-9">
            <div class="card shadow-lg border-0">
                <div class="card-body p-5">
                    <form id="uploadForm" enctype="multipart/form-data" class="text-center">
                        <div id="filePickerContainer" class="mb-4">
                            <input type="file" id="imageInput" name="image" accept="image/*" class="form-control" required>
                        </div>

                        <!-- Image preview (hidden by default) -->
                        <div id="imageContainer" class="fade mt-4" style="display: none;">
                            <h3 class="text-center fw-medium mb-3">Selected Image</h3>
                            <div class="d-flex justify-content-center" >
                                <img id="previewImage" class="img-fluid shadow" style="max-width: 99%;"/>
                            </div>
                        </div>

                        <div class="my-5 text-center">
                            <button id="runDetectionBtn" type="submit" class="btn btn-primary btn-lg px-5">Run Visualisation</button>
                        </div>
                    </form>

                    <!-- Progress bar (hidden by default) -->
                    <div id="progressContainer" class="progress mt-4 fade" style="display: none; height: 24px;">
                        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-success" 
                            role="progressbar" style="width: 0%; height: 100%">0%</div>
                    </div>

                    <!-- Detection result (hidden by default) -->
                    <div id="detectionContainer" style="display: none;" class="fade mt-5">
                        <h3 class="mt-4 mb-3 fw-medium text-center">Visualisation Result</h3>
                        <div class="d-flex justify-content-center">
                            <img id="resultImage" class="img-fluid mt-2 shadow" style="max-width: 99%;"/>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detection adjustments menu  (hidden by default)-->
     <div id="adjustmentsMenu" class="offcanvas offcanvas-start fade" tabindex="-1" style="width: 300px;" aria-labelledby="adjustmentsMenuLabel">
        <div class="offcanvas-header">
            <h4 id="adjustmentsMenuLabel">Detections Menu</h4>
            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas"></button>
        </div>

        <div class="offcanvas-body">
            <!-- Adjustments form, used to continue or change the detections -->
            <form id="adjustmentsForm" class="text-center">
                <div class="mb-3">
                    <h5>
                        Is everything correct?
                    </h5>
                    <div class="mt-3 mb-5 d-grid gap-2">
                        <button id="confirmOffsideBtn" type="submit" class="btn btn-success">Proceed to Offside Detection</button>
                    </div>

                    <h5>
                        Does something need changing?
                    </h5>
                    <div class="mt-3 mb-5 d-grid gap-2">
                        <button id="manualTeamChange" type="submit" class="btn btn-primary">Adjust Visualisation</button>
                    </div>

                    <h5>
                        Should detection be run again?
                    </h5>
                    <div class="mt-3 mb-1">
                        <label for="confidenceSlider" class="form-label">Confidence Threshold:</label>
                        <input type="range" class="form-range" id="confidenceSlider" min="0" max="1" step="0.1" value="0.5">
                        <span id="confidenceValue">0.5</span>
                    </div>
                    <div class="mt-3 mb-5 d-grid gap-2">
                        <button id="rerunDetectionBtn" type="submit" class="btn btn-warning">Rerun Visualisation</button>
                    </div>

                    <h5>
                        Otherwise
                    </h5>
                    <div class="mt-3 d-grid gap-2">
                        <button id="cancelDetectionBtn" type="submit" class="btn btn-danger">Start Again</button>
                    </div>
                </div>
            </form>

            <!-- Tweaks form, dynamically generated by amount of detections (hidden by default) -->
            <form id=tweaksForm class="text-center" style="display: none;">
            </form>

            <!-- Defending team selection form, used when there is no goalkeeper (hidden by default)-->
             <form id="defendingForm" class="text-center" style="display: none;">
                <h5>
                    Select the Defending Team
                </h5>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="defendingTeam" id="teamA" value="Team A" checked>
                    <label class="form-check-label" for="teamA">
                    Team A
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="defendingTeam" id="teamB" value="Team B">
                    <label class="form-check-label" for="teamB">
                    Team B
                    </label>
                </div>
                <button type="submit" class="btn btn-primary">Submit</button>
             </form>
        </div>
     </div>
     <div id="alert-container" class="position-fixed top-0 end-0 p-3" style="z-index: 1050;"></div>
</div>

{% csrf_token %}
{% load static %}
<script>
    const processImageUrl = "{% url 'process_image' %}";
    const renderPitchUrl = "{% url 'render_pitch' %}";
    const classifyOffsideUrl = "{% url 'classify_offside' %}";
    const updateDetectionsUrl = "{% url 'update_detections' %}";
</script>
<script src="{% static 'javascript/image_upload.js' %}"></script>

{% endblock %}
