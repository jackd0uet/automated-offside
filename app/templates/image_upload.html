{% extends "base_generic.html" %}

{% block content %}
<div class="container mt-4">
    <h2 class="text-center mb-4">Upload an Image for Object Detection</h2>
    
    <form id="uploadForm" enctype="multipart/form-data" class="text-center">
        <div class="mb-3">
            <input type="file" id="imageInput" name="image" accept="image/*" class="form-control" required>
        </div>
        <button type="submit" class="btn btn-primary">Run Detection</button>
    </form>

    <h3 class="mt-4 text-center">Selected Image:</h3>
    <div class="d-flex justify-content-center">
        <img id="previewImage" class="img-fluid mt-2" style="max-width: 500px; display: none;"/>
    </div>

    <!-- Progress bar (hidden by default) -->
    <div class="progress mt-3" style="display: none; height: 20px;" id="progressContainer">
        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-success" 
             role="progressbar" style="width: 0%;">0%</div>
    </div>

    <h3 class="mt-4 text-center">Detection Result:</h3>
    <div class="d-flex justify-content-center">
        <img id="resultImage" class="img-fluid mt-2" style="max-width: 500px; display: none;"/>
    </div>
</div>

<script>
    document.getElementById("imageInput").addEventListener("change", function(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const previewImage = document.getElementById("previewImage");
                previewImage.src = e.target.result;
                previewImage.style.display = "block";
            };
            reader.readAsDataURL(file);
        }
    });

    document.getElementById("uploadForm").addEventListener("submit", function(event) {
        event.preventDefault();
        
        const formData = new FormData();
        const imageInput = document.getElementById("imageInput");
        
        if (imageInput.files.length === 0) {
            alert("Please select an image.");
            return;
        }

        formData.append("image", imageInput.files[0]);

        // Show progress bar
        document.getElementById("progressBar").style.width = "0%";
        document.getElementById("progressContainer").style.display = "block";

        const interval = setInterval(() => {
            let width = parseInt(document.getElementById("progressBar").style.width);
            if (width < 95) {
                document.getElementById("progressBar").style.width = (width + 5) + "%";
            }
        }, 500);

        fetch("{% url 'process_image' %}", {
            method: "POST",
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error("Failed to process image");
            }
            return response.json();  // Expect JSON response with detection data
        })
        .then(data => {
            clearInterval(interval);
            document.getElementById("progressBar").style.width = "100%";

            // Send detections to render the pitch
            return fetch("{% url 'render_pitch' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    ball_xy: data.ball_xy,
                    players_xy: data.players_xy,
                    refs_xy: data.refs_xy,
                    players_detections: data.players_detections
                })
            });
        })
        .then(response => response.blob())
        .then(blob => {
            const imgUrl = URL.createObjectURL(blob);
            document.getElementById("resultImage").src = imgUrl;
            document.getElementById("resultImage").style.display = "block";
        })
        .catch(error => {
            console.error("Error:", error);
            alert("Error processing image. Please try again.");
        })
        .finally(() => {
            clearInterval(interval);
            document.getElementById("progressContainer").style.display = "none";
        });
    });

    document.getElementById("imageInput").addEventListener("change", function(event) {
        const file = event.target.files[0];
        if (file) {
            const imgUrl = URL.createObjectURL(file);
            document.getElementById("selectedImage").src = imgUrl;
            document.getElementById("selectedImage").style.display = "block";
        }
    });
</script>

{% endblock %}
